# å·¥å…·è¾“å…¥æ¨¡å¼

é»˜è®¤æƒ…å†µä¸‹ï¼Œå·¥å…·é€šè¿‡æ£€æŸ¥å‡½æ•°ç­¾åæ¥æ¨æ–­å‚æ•°æ¨¡å¼ã€‚ä¸ºäº†æ›´ä¸¥æ ¼çš„è¦æ±‚ï¼Œå¯ä»¥æŒ‡å®šè‡ªå®šä¹‰è¾“å…¥æ¨¡å¼ï¼Œä»¥åŠè‡ªå®šä¹‰éªŒè¯é€»è¾‘ã€‚

```python
from typing import Any, Dict

from langchain.agents import AgentType, initialize_agent
from langchain.llms import OpenAI
from langchain.tools.requests.tool import RequestsGetTool, TextRequestsWrapper
from pydantic import BaseModel, Field, root_validator
``` 

ä»¥ä¸Šä»£ç å¯¼å…¥äº†ä¸€äº›éœ€è¦ç”¨åˆ°çš„åº“å’Œæ¨¡å—ã€‚

```python
llm = OpenAI(temperature=0)
```

åˆ›å»ºä¸€ä¸ªOpenAIå¯¹è±¡ï¼Œç”¨äºè°ƒç”¨OpenAIçš„APIã€‚

```python
!pip install tldextract > /dev/null
```

å®‰è£…`tldextract`åº“ï¼Œç”¨äºä»urlä¸­æå–åŸŸåã€‚

```python
[notice] A new release of pip is available: 23.0.1 -> 23.1
[notice] To update, run: pip install --upgrade pip
```

æ˜¾ç¤ºpipå¯å‡çº§çš„æç¤ºä¿¡æ¯ã€‚

```python
import tldextract

_APPROVED_DOMAINS = {
    "langchain",
    "wikipedia",
}

class ToolInputSchema(BaseModel):

    url: str = Field(...)
    
    @root_validator
    def validate_query(cls, values: Dict[str, Any]) -> Dict:
        url = values["url"]
        domain = tldextract.extract(url).domain
        if domain not in _APPROVED_DOMAINS:
            raise
```

ä»¥ä¸Šä»£ç å®šä¹‰äº†ä¸€ä¸ªå·¥å…·è¾“å…¥æ¨¡å¼ï¼ŒåŒ…å«äº†urlå­—æ®µã€‚ä½¿ç”¨`root_validator`è£…é¥°å™¨å®šä¹‰äº†ä¸€ä¸ªéªŒè¯å™¨ï¼Œç”¨äºéªŒè¯urlæ˜¯å¦å±äºæŒ‡å®šçš„åŸŸåä¹‹ä¸€ã€‚

å¦‚æœä¸å±äºï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚`ValueError(f"åŸŸå {domain} `ä¸åœ¨æ‰¹å‡†åˆ—è¡¨ä¸­: `{sorted(_APPROVED_DOMAINS)}")`
    return values
    
```python
tool = RequestsGetTool(args_schema=ToolInputSchema, requests_wrapper=TextRequestsWrapper())

```










```python
agent = initialize_agent([tool], llm, agent=AgentType.ZERO_SHOT_REACT_DESCRIPTION, verbose=False)

```










```python
# è¿™å°†æˆåŠŸï¼Œå› ä¸ºåœ¨éªŒè¯æœŸé—´ä¸ä¼šè§¦å‘ä»»ä½•å‚æ•°
answer = agent.run("langchain.com çš„ä¸»æ ‡é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ")
print(answer)

```








```python
langchain.com çš„ä¸»æ ‡é¢˜æ˜¯ "LANG CHAIN ğŸ¦œï¸ğŸ”— å®˜æ–¹ä¸»é¡µ"

```










```python
agent.run("google.com çš„ä¸»æ ‡é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ")

```








```python

ValidationError Traceback (most recent call last)
Cell In[7], line 1
----> 1 agent.run("google.com çš„ä¸»æ ‡é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ")

File ~/code/lc/lckg/langchain/chains/base.py:213, in Chain.run(self, \*args```python

``` 

```python
åœ¨æ–‡ä»¶~/code/lc/lckg/langchain/chains/base.pyä¸­çš„116è¡Œï¼ŒChainçš„__call__æ–¹æ³•æŠ›å‡ºå¼‚å¸¸ã€‚åœ¨113è¡Œï¼Œè¯¥æ–¹æ³•è°ƒç”¨_callæ–¹æ³•ï¼Œå¹¶åœ¨tryè¯­å¥ä¸­æ•è·å¼‚å¸¸ã€‚åœ¨110è¡Œåˆ°111è¡Œä¹‹é—´ï¼ŒChainçš„callback_managerç®¡ç†å™¨çš„on_chain_startæ–¹æ³•è¢«è°ƒç”¨ï¼Œä¼ é€’äº†Chainçš„åç§°å’Œè¾“å…¥å‚æ•°ã€‚å¦‚æœkwargså­˜åœ¨ä¸”argsä¸å­˜åœ¨ï¼Œåˆ™åœ¨215è¡Œè¿”å›self(kwargs)[self.output_keys[0]]ã€‚å¦‚æœargså­˜åœ¨ä¸”é•¿åº¦ä¸ç­‰äº1ï¼Œåˆ™åœ¨212è¡Œå¼•å‘ValueErrorå¼‚å¸¸ã€‚å¦åˆ™ï¼Œåœ¨213è¡Œè¿”å›self(args[0])[self.output_keys[0]]ã€‚å¦‚æœtryè¯­å¥å—å†…æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™åœ¨115è¡Œè°ƒç”¨Chainçš„callback_managerç®¡ç†å™¨çš„on_chain_erroræ–¹æ³•ï¼Œå¹¶é‡æ–°æŠ›å‡ºå¼‚å¸¸ã€‚åœ¨118è¡Œï¼ŒChainçš„callback_managerç®¡ç†å™¨çš„on_chain_endæ–¹æ³•è¢«è°ƒç”¨ï¼Œä¼ é€’äº†è¾“å‡ºå‚æ•°å’Œverboseå‚æ•°ã€‚æœ€åï¼Œåœ¨119è¡Œè¿”å›prep_outputsæ–¹æ³•çš„ç»“æœï¼Œè¯¥æ–¹æ³•æ¥æ”¶è¾“å…¥å‚æ•°ã€è¾“å‡ºå‚æ•°å’Œreturn_only_outputså‚æ•°ã€‚åœ¨æ–‡ä»¶~/code/lc/lckg/langchain/agents/agent.pyçš„ç¬¬792è¡Œï¼Œå½“å‡ºç°é“¾é”™è¯¯æ—¶ï¼Œè°ƒç”¨back_manager.on_chain_error(e, verbose=self.verbose)å‡½æ•°ã€‚

åœ¨æ–‡ä»¶~/code/lc/lckg/langchain/agents/agent.pyçš„ç¬¬790è¡Œï¼Œè¿›å…¥Agentå¾ªç¯ï¼Œç›´åˆ°è¿”å›æŸäº›ä¸œè¥¿ã€‚

åœ¨AgentExecutor._call(self, inputs)å‡½æ•°ä¸­ï¼Œç¬¬792è¡Œè°ƒç”¨äº†_take_next_step()å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼ å…¥name_to_tool_mapã€color_mappingã€inputså’Œintermediate_stepså‚æ•°ã€‚

åœ¨AgentExecutor._take_next_step(self, name_to_tool_map, color_mapping, inputs, intermediate_steps)å‡½æ•°ä¸­ï¼Œç¬¬695è¡Œè°ƒç”¨äº†tool.run()å‡½æ•°ï¼Œä¼ å…¥agent_action.tool_inputã€verbose=self.verboseã€colorå’Œtool_run_kwargsç­‰å‚æ•°ï¼Œä»¥è·å–è§‚å¯Ÿå€¼ã€‚å¦‚æœagent_actionæ˜¯Noneï¼Œåˆ™è¿”å›Noneã€‚åœ¨æ–‡ä»¶~/code/lc/lckg/langchain/tools/base.pyçš„ç¬¬110è¡Œï¼ŒBaseToolç±»çš„runæ–¹æ³•ä¸­ï¼Œè·å–äº†self.agent.tool_run_logging_kwargs()çš„å‚æ•°å¹¶èµ‹å€¼ç»™tool_run_kwargsã€‚

åœ¨æ–‡ä»¶~/code/lc/lckg/langchain/tools/base.pyçš„ç¬¬71è¡Œï¼ŒBaseToolç±»çš„_parse_inputæ–¹æ³•ä¸­ï¼Œè§£æäº†tool_inputï¼Œå¹¶å°†å…¶è¿”å›ã€‚

åœ¨æ–‡ä»¶~/code/lc/lckg/.venv/lib/python3.11/site-packages/pydantic/main.pyçš„ç¬¬526è¡Œï¼ŒBaseModelç±»çš„parse_objæ–¹æ³•è¢«è°ƒç”¨ã€‚åœ¨/pydantic/main.pyçš„ç¬¬341è¡Œï¼Œpydantic.main.BaseModel.__init__()å‡½æ•°çš„å‚æ•°æ ¡éªŒå‡ºé”™äº†ï¼Œé”™è¯¯ä¿¡æ¯æ˜¯ï¼šToolInputSchemaçš„__root__å­—æ®µçš„å€¼ä¸åœ¨['langchain', 'wikipedia']ä¸­ï¼Œä¸ç¬¦åˆè¦æ±‚ã€‚

```  python